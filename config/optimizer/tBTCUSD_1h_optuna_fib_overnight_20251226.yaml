description: "Overnight Optuna - Fib-focused (HTF integrity fixes) - 2024 window"
# Goal:
# - Specifically stress-test the updated HTF/LTF Fibonacci gating + HTF-exit fib machinery
# - Keep non-fib knobs mostly fixed to reduce confounding
# - Use a fresh Optuna DB + promotion disabled (safety)
# - Long-ish runtime via timeout (overnight)

meta:
  symbol: tBTCUSD
  timeframe: 1h
  snapshot_id: snap_tBTCUSD_2024-01-01_2024-12-31_v1
  warmup_bars: 150
  runs:
    strategy: optuna

    # Use the full 2024 window (same as our stepwise backtests)
    use_sample_range: true
    sample_start: "2024-01-01"
    sample_end: "2024-12-31"

    # Fresh run; resume ok if you stop/restart tonight.
    resume: true

    # This machine has 4C/4T and ~16 GB RAM; keep concurrency low for SQLite stability.
    max_concurrent: 1

    # Let timeout decide how long it runs.
    max_trials: null

    # Optional: seed a random exploration phase before TPE (runner supports this pattern).
    bootstrap_random_trials: 32
    bootstrap_seed: 42

    promotion:
      enabled: false

    optuna:
      study_name: "optuna_fib_overnight_20251226_v2"
      storage: "sqlite:///results/hparam_search/storage/optuna_fib_overnight_20251226_v2.db"
      n_jobs: 1
      timeout_seconds: 36000 # 10h

      pruner:
        type: "median"
        kwargs:
          n_startup_trials: 10
          n_warmup_steps: 2000
          interval_steps: 100

      sampler:
        type: "tpe"
        kwargs:
          n_startup_trials: 30
          n_ei_candidates: 64
          multivariate: true
          group: true
          seed: 42

# Keep constraints mild enough to preserve learning signal; filter strictly afterwards.
constraints:
  min_trades: 20
  min_profit_factor: 0.95
  max_max_dd: 0.30
  include_scoring_failures: false

parameters:
  # --- Keep core entry behavior fixed (reduce confounding) ---
  thresholds:
    entry_conf_overall:
      type: fixed
      value: 0.24

    regime_proba:
      balanced:
        type: fixed
        value: 0.46
      bull:
        type: fixed
        value: 0.50
      bear:
        type: fixed
        value: 0.44
      ranging:
        type: fixed
        value: 0.46

    min_edge:
      type: fixed
      value: 0.01

    signal_adaptation:
      atr_period:
        type: fixed
        value: 28
      zones:
        low:
          entry_conf_overall:
            type: fixed
            value: 0.25
          regime_proba:
            type: fixed
            value: 0.36
        mid:
          entry_conf_overall:
            type: fixed
            value: 0.32
          regime_proba:
            type: fixed
            value: 0.44
        high:
          entry_conf_overall:
            type: fixed
            value: 0.38
          regime_proba:
            type: fixed
            value: 0.56

  # --- Exit: lock in the only tweak that actually moved behavior (SL=3%) ---
  exit:
    enabled:
      type: fixed
      value: true
    exit_conf_threshold:
      type: fixed
      value: 0.42
    max_hold_bars:
      type: fixed
      value: 12
    trailing_stop_enabled:
      type: fixed
      value: true
    trailing_stop_pct:
      type: fixed
      value: 0.015
    stop_loss_pct:
      type: fixed
      value: 0.03
    take_profit_pct:
      type: fixed
      value: 0.05
    regime_aware_exits:
      type: fixed
      value: true

  # --- Multi-timeframe gating: fixed to current best-known behavior ---
  multi_timeframe:
    use_htf_block:
      type: fixed
      value: true
    allow_ltf_override:
      type: fixed
      value: true
    ltf_override_threshold:
      type: fixed
      value: 0.36
    ltf_override_adaptive:
      enabled:
        type: fixed
        value: true
      window:
        type: fixed
        value: 120
      percentile:
        type: fixed
        value: 0.85
      min_history:
        type: fixed
        value: 30

  # --- Fib gating knobs (primary target) ---
  htf_fib:
    entry:
      tolerance_atr:
        type: float
        low: 3.0
        high: 5.5
        step: 0.25
      long_max_level:
        type: grid
        values: [-0.10, -0.05, 0.0, 0.146, 0.20, 0.236]
      short_min_level:
        type: grid
        values: [-0.272, -0.25, -0.236, -0.146, -0.05, 0.0, 0.146, 0.236, 0.35]

  ltf_fib:
    entry:
      tolerance_atr:
        type: float
        low: 1.2
        high: 2.4
        step: 0.1
      long_max_level:
        type: grid
        values: [0.146, 0.20, 0.236, 0.382, 0.50]
      short_min_level:
        type: grid
        values: [0.236, 0.35, 0.382, 0.50]

  # --- HTF exit fib mechanics (secondary target) ---
  htf_exit_config:
    enable_partials:
      type: fixed
      value: true
    enable_trailing:
      type: fixed
      value: true
    enable_structure_breaks:
      type: fixed
      value: true

    partial_1_pct:
      type: fixed
      value: 0.6
    partial_2_pct:
      type: fixed
      value: 0.5

    fib_threshold_atr:
      type: float
      low: 0.55
      high: 0.95
      step: 0.05

    trail_atr_multiplier:
      type: float
      low: 1.5
      high: 3.0
      step: 0.1

    swing_update_strategy:
      type: fixed
      value: "fixed"
