description: "Optuna - HTF exits tuning (2026-01-02..2026-01-05)"
# NOTE:
# - This config is intentionally scoped to HTF exit parameters (htf_exit_config.*).
# - Preflight will FAIL until candle data covers the requested window.
# - Timeframe is set to 1h to keep champion-validation meaningful (champion exists for tBTCUSD_1h).

meta:
  symbol: tBTCUSD
  timeframe: 1h
  snapshot_id: snap_tBTCUSD_2026-01-02_2026-01-05_v1
  runs:
    strategy: optuna
    resume: true
    max_trials: 30
    max_concurrent: 1
    promotion:
      enabled: false
    use_sample_range: true
    sample_start: "2024-01-02"
    sample_end: "2025-12-11"
    optuna:
      study_name: "optuna_htf_exits_20260102_20260105"
      storage: "sqlite:///results/hparam_search/storage/optuna_tBTCUSD_1h_htf_exits_20260102_20260105.db"
      n_jobs: 1
      timeout_seconds: 21600
      pruner:
        type: "median"
        kwargs:
          n_startup_trials: 5
          n_warmup_steps: 500
          interval_steps: 100
      sampler:
        type: "tpe"
        kwargs:
          n_startup_trials: 15
          n_ei_candidates: 64
          multivariate: true
          group: true
          seed: 42

constraints:
  # Mild constraints: goal is exit-parameter signal, not aggressive filtering.
  min_trades: 1
  min_profit_factor: 0.8
  max_max_dd: 0.5
  include_scoring_failures: false

parameters:
  # Keep entry/thresholding pinned to the current 1h champion to avoid confounds.
  thresholds:
    entry_conf_overall:
      type: fixed
      value: 0.24

    regime_proba:
      balanced:
        type: fixed
        value: 0.46
      bull:
        type: fixed
        value: 0.50
      bear:
        type: fixed
        value: 0.44
      ranging:
        type: fixed
        value: 0.46

    min_edge:
      type: fixed
      value: 0.01

    signal_adaptation:
      atr_period:
        type: fixed
        value: 28
      zones:
        low:
          entry_conf_overall:
            type: fixed
            value: 0.25
          regime_proba:
            type: fixed
            value: 0.36
        mid:
          entry_conf_overall:
            type: fixed
            value: 0.32
          regime_proba:
            type: fixed
            value: 0.44
        high:
          entry_conf_overall:
            type: fixed
            value: 0.38
          regime_proba:
            type: fixed
            value: 0.56

  exit:
    exit_conf_threshold:
      type: fixed
      value: 0.46
    max_hold_bars:
      type: fixed
      value: 12
    # NOTE: stop_loss_pct is used as an emergency stop in the engine (exit reason EMERGENCY_SL).
    # Pin it here to avoid hidden defaults during HTF-exit tuning.
    stop_loss_pct:
      type: fixed
      value: 0.03
    take_profit_pct:
      type: fixed
      value: 0.05

  # Keep risk pinned (no optimization) to avoid unintentional risk-policy drift during exit tuning.
  risk:
    risk_map:
      type: fixed
      value:
        - [0.6, 0.02]
        - [0.7, 0.03]
        - [0.8, 0.04]
        - [0.9, 0.05]

  # Avoid dead runs if fib context is temporarily unavailable.
  htf_fib:
    entry:
      missing_policy:
        type: fixed
        value: "pass"

  ltf_fib:
    entry:
      missing_policy:
        type: fixed
        value: "pass"

  # Target parameters.
  htf_exit_config:
    partial_1_pct:
      type: float
      low: 0.50
      high: 0.70
      step: 0.02
    partial_2_pct:
      type: float
      low: 0.35
      high: 0.60
      step: 0.05
    fib_threshold_atr:
      type: float
      low: 0.70
      high: 0.95
      step: 0.05
    trail_atr_multiplier:
      type: float
      low: 2.40
      high: 3.40
      step: 0.10

    enable_partials:
      type: fixed
      value: true
    enable_trailing:
      type: fixed
      value: true
    enable_structure_breaks:
      type: fixed
      value: true
