# Optuna Configuration for Phase 3 Stabilized v3 (Correction)
# Focus: Correcting "Too Many Bad Trades" from v2 (2600 trades, PF 0.8)
# Strategy: Tighten thresholds to find middle ground between v1 (0 trades) and v2 (2600 trades)

meta:
  symbol: "tBTCUSD"
  timeframe: "1h"
  snapshot_id: "snap_tBTCUSD_2024-01-01_2024-12-31_v1"
  runs:
    strategy: "optuna"
    max_trials: 100
    max_concurrent: 4
    optuna:
      study_name: "tBTCUSD_1h_phase3_stabilized_v3"
      storage: "sqlite:///results/hparam_search/storage/optuna_phase3_stabilized_v3.db"
      direction: "maximize"
      timeout_seconds: 14400 # 4 hours
      sampler:
        type: "tpe"
        kwargs:
          n_startup_trials: 20
          n_ei_candidates: 24
          multivariate: true
          seed: 42
      pruner:
        type: "median"
        kwargs:
          n_startup_trials: 10
          n_warmup_steps: 100
          interval_steps: 50

# Parameter search space
parameters:
  # --- Entry Thresholds (Tightened from v2) ---
  thresholds.entry_conf_overall:
    type: "float"
    low: 0.32
    high: 0.42
    step: 0.01

  thresholds.min_edge:
    type: "float"
    low: 0.008
    high: 0.020
    step: 0.001

  # --- Signal Adaptation (Shifted up ~0.05) ---
  thresholds.signal_adaptation.zones.low.entry_conf_overall:
    type: "float"
    low: 0.28
    high: 0.35
    step: 0.01
  thresholds.signal_adaptation.zones.low.regime_proba:
    type: "float"
    low: 0.40
    high: 0.55
    step: 0.01

  thresholds.signal_adaptation.zones.mid.entry_conf_overall:
    type: "float"
    low: 0.32
    high: 0.40
    step: 0.01
  thresholds.signal_adaptation.zones.mid.regime_proba:
    type: "float"
    low: 0.45
    high: 0.60
    step: 0.01

  thresholds.signal_adaptation.zones.high.entry_conf_overall:
    type: "float"
    low: 0.38
    high: 0.48
    step: 0.01
  thresholds.signal_adaptation.zones.high.regime_proba:
    type: "float"
    low: 0.55
    high: 0.70
    step: 0.01

  # --- Exit Strategy ---
  exit.exit_conf_threshold:
    type: "float"
    low: 0.40
    high: 0.55
    step: 0.01

  exit.max_hold_bars:
    type: "int"
    low: 12
    high: 64
    step: 4

  exit.trailing_stop_pct:
    type: "float"
    low: 0.015
    high: 0.05
    step: 0.005

  # --- Multi-Timeframe (Fibonacci) ---
  multi_timeframe.ltf_override_threshold:
    type: "float"
    low: 0.35
    high: 0.55
    step: 0.01

  multi_timeframe.ltf_override_adaptive.percentile:
    type: "float"
    low: 0.85
    high: 0.98
    step: 0.01

  multi_timeframe.htf_fib.entry.tolerance_atr:
    type: "float"
    low: 1.5
    high: 4.0
    step: 0.25

  multi_timeframe.ltf_fib.entry.tolerance_atr:
    type: "float"
    low: 1.0
    high: 3.0
    step: 0.1

  # --- Risk Management (Less aggressive deltas) ---
  risk.risk_map_deltas.conf_0:
    type: "float"
    low: -0.10
    high: 0.00
    step: 0.01
  risk.risk_map_deltas.size_0:
    type: "float"
    low: -0.005
    high: 0.005
    step: 0.001

  risk.risk_map_deltas.conf_1:
    type: "float"
    low: -0.12
    high: -0.02
    step: 0.01
  risk.risk_map_deltas.size_1:
    type: "float"
    low: -0.005
    high: 0.005
    step: 0.001

  risk.risk_map_deltas.conf_2:
    type: "float"
    low: -0.15
    high: -0.05
    step: 0.01
  risk.risk_map_deltas.size_2:
    type: "float"
    low: -0.015
    high: 0.015
    step: 0.005

# Constraints
constraints:
  min_trades: 50
  min_profit_factor: 1.05
  max_max_dd: 0.25
  include_scoring_failures: true

# Fixed parameters
fixed:
  warmup_bars: 150
  use_multiprocessing: true
