description: "Optuna SMOKE - HTF fib integrity (short window, in-memory storage)"
# Purpose:
# - Fast end-to-end Optuna pipeline check (config -> transforms -> backtest -> scoring -> artifacts)
# - Uses a short sample range to keep runtime low
# - Uses in-memory Optuna storage to avoid DB collisions

meta:
  symbol: tBTCUSD
  timeframe: 1h
  snapshot_id: snap_tBTCUSD_2024-12-03_2024-12-11_v1
  runs:
    strategy: optuna
    resume: false
    max_trials: 3
    max_concurrent: 1
    promotion:
      enabled: false
    use_sample_range: true
    sample_start: "2024-12-03 05:00:00"
    sample_end: "2024-12-11 12:00:00"
    optuna:
      study_name: "optuna_smoke_htf_fix"
      storage: null
      n_jobs: 1
      timeout_seconds: 900
      pruner:
        type: "median"
        kwargs:
          n_startup_trials: 1
          n_warmup_steps: 500
          interval_steps: 100
      sampler:
        type: "tpe"
        kwargs:
          n_startup_trials: 2
          n_ei_candidates: 16
          multivariate: true
          group: true
          seed: 42

# Keep constraints deliberately mild for smoke; the goal is "run completes" not "best trial".
constraints:
  min_trades: 1
  min_profit_factor: 0.8
  max_max_dd: 0.5
  include_scoring_failures: false

# Keep parameter space aligned with the Phase 3 Fine v7 config so champion-compat validation stays meaningful.
parameters:
  thresholds:
    entry_conf_overall:
      type: float
      low: 0.18
      high: 0.30
      step: 0.01

    regime_proba:
      balanced:
        type: fixed
        value: 0.46
      bull:
        type: fixed
        value: 0.50
      bear:
        type: fixed
        value: 0.44
      ranging:
        type: fixed
        value: 0.46

    min_edge:
      type: float
      low: 0.005
      high: 0.012
      step: 0.001

    signal_adaptation:
      atr_period:
        type: fixed
        value: 28
      zones:
        low:
          entry_conf_overall:
            type: float
            low: 0.20
            high: 0.30
            step: 0.01
          regime_proba:
            type: float
            low: 0.30
            high: 0.42
            step: 0.01
        mid:
          entry_conf_overall:
            type: float
            low: 0.28
            high: 0.36
            step: 0.01
          regime_proba:
            type: float
            low: 0.40
            high: 0.50
            step: 0.01
        high:
          entry_conf_overall:
            type: float
            low: 0.34
            high: 0.42
            step: 0.01
          regime_proba:
            type: float
            low: 0.50
            high: 0.62
            step: 0.01

  exit:
    exit_conf_threshold:
      type: float
      low: 0.38
      high: 0.48
      step: 0.01
    max_hold_bars:
      type: int
      low: 8
      high: 24
      step: 2
    trailing_stop_pct:
      type: float
      low: 0.01
      high: 0.025
      step: 0.0025

  # Match the current champion risk policy to avoid validation failures and confounds in smoke.
  risk:
    risk_map:
      type: fixed
      value:
        - [0.6, 0.02]
        - [0.7, 0.03]
        - [0.8, 0.04]
        - [0.9, 0.05]

  # Include HTF-exit params explicitly so champion validation can assert compatibility.
  htf_exit_config:
    enable_partials:
      type: fixed
      value: true
    enable_trailing:
      type: fixed
      value: true
    enable_structure_breaks:
      type: fixed
      value: true
    partial_1_pct:
      type: fixed
      value: 0.6
    partial_2_pct:
      type: fixed
      value: 0.5
    fib_threshold_atr:
      type: fixed
      value: 0.8
    trail_atr_multiplier:
      type: fixed
      value: 2.9

  multi_timeframe:
    ltf_override_threshold:
      type: float
      low: 0.30
      high: 0.45
      step: 0.01
    ltf_override_adaptive:
      percentile:
        type: float
        low: 0.80
        high: 0.90
        step: 0.01

  htf_fib:
    entry:
      tolerance_atr:
        type: float
        low: 3.5
        high: 5.0
        step: 0.25

  ltf_fib:
    entry:
      tolerance_atr:
        type: float
        low: 1.4
        high: 2.2
        step: 0.1
