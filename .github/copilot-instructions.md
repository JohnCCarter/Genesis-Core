<!-- Generated by Copilot -->
# Genesis-Core Copilot Guide

## Architecture Snapshot
- FastAPI entrypoint in `src/core/server.py` wires runtime config, trading endpoints, and Bitfinex REST/WS helpers; keep endpoints thin and push logic into pure strategy modules.
- Core trading loop lives in `src/core/strategy/` with deterministic, side-effect free functions; responders expect Swedish language per `.cursor/rules/cursor-active-rules.mdc`.
- Champion configs under `config/strategy/champions/` are the primary source for runtime thresholds; `ChampionLoader` falls back to `config/timeframe_configs.py` when files are missing.

## Strategy Pipeline
- `evaluate_pipeline` merges the loaded champion with any request overrides, extracts features via `features_asof.extract_features`, predicts probability (`prob_model`), derives confidence, and runs `decision.decide` with ATR/regime/Fibonacci gating.
- Feature extraction enforces AS-OF semantics: live mode uses the second-to-last bar; backtests pick an explicit `asof_bar`. Inspect `features_asof.py` before altering data windows.
- State hand-off: `decide` returns `state_out` carrying ATR percentiles, Fibonacci context, hysteresis counters, and cooldown; backtests feed this state into the next bar. Preserve these keys when changing structures.

## Configuration & SSOT
- Runtime SSOT lives outside git in `config/runtime.json`; read/write via `ConfigAuthority` to preserve atomic writes, version locks, hashes, and `logs/config_audit.jsonl` rotation.
- `/config/runtime/propose` only accepts whitelisted patches (`thresholds`, `gates`, `risk.risk_map`, `ev.R_default`). Extend enums in `core/config/schema.py` and update validators if new fields are introduced.
- Settings (`core/config/settings.py`) load `.env`; tests rely on `SYMBOL_MODE=synthetic` to map to TEST symbols.

## Backtesting & Optimizer
- `scripts/run_backtest.py` wraps `core/backtest/engine.BacktestEngine`, pulling Parquet data from `data/curated/v1/candles/` and champion configs. Use `--config-file` with `{"cfg": {...}}` payloads for overrides.
- Optimizer runs flow coarse → proxy → fine (`README.agents.md`, `docs/optimizer.md`): invoke `python -m core.optimizer.runner <config.yaml>`, then `scripts/optimizer.py summarize`. Results and cached payloads land under `results/hparam_search/run_*`.
- Trial configs deep-merge on top of the current SSOT; if you change schema, update `_deep_merge` logic in `core/optimizer/runner.py` and adjust `tests/test_optimizer_runner.py` expectations.

## Bitfinex Integration
- REST client (`core/io/bitfinex/exchange_client.py`) signs payloads with canonical `json.dumps(..., separators=(",", ":"))`; mirror that serialization anywhere we build auth bodies.
- Nonce handling uses `core/utils/nonce_manager.py`; on nonce errors call `bump_nonce` before retrying. WebSocket helpers follow the same symbol mapping rules.
- Keep `SymbolMapper` aligned with TEST routing; new symbols require updates in both `DEFAULT_MAP` and the whitelist in `src/core/server.py`.

## Observability & Logging
- Metrics are in-memory gauges/counters (`core/observability/metrics.py`) exposed at `/observability/dashboard`; wrap new pipeline events with `metrics.event/metrics.inc`.
- Logs must pass through `core/utils/logging_redaction` to mask API keys. If you add custom logging, fetch loggers through `get_logger`.

## Testing & QA
- Primary CI script: `pwsh -File scripts/ci.ps1` (black → ruff → bandit → pytest). Bandit runs should skip third-party noise: `bandit -r src -ll --skip B101,B102,B110`.
- Critical smoke tests: `pytest tests/test_config_api_e2e.py::test_runtime_endpoints_e2e`, `tests/test_exchange_client.py::test_build_and_request_smoke`, `tests/test_ui_endpoints.py::test_debug_auth_masked` (require `.env` placeholders).
- Backtest/optimizer changes must update snapshots in `tests/test_optimizer_*` or regenerate fixture outputs referenced in `results/`.

## Patterns & Conventions
- Keep `core/strategy/*` pure and deterministic; no direct I/O, and return metadata for observability.
- When expanding state/meta payloads, document new keys in `README.agents.md` to keep agent hand-offs accurate.
- Avoid touching gitignored runtime files (`config/runtime.json`, `logs/config_audit.jsonl`) directly in commits; use the APIs.
- Store generated reports/backtests in the existing `results/backtests/` and `results/hparam_search/` structures rather than inventing new folders.
