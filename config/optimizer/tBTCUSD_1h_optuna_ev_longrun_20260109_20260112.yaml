description: "Optuna Explore→Validate long-run (wall-clock 2026-01-09..2026-01-12)"
#
# Purpose:
# - Run the existing Explore→Validate long-run template during a fixed wall-clock window.
# - This DOES NOT change the market-data sample windows below; it only controls when the run stops.
#
# Stop policy:
# - The runner supports `optuna.end_at` (absolute deadline) and `optuna.timeout_seconds` (relative budget).
# - If both are set, the effective time budget is the MIN(remaining relative, remaining to end_at).
#
# Safety:
# - promotion is disabled.
# - storage + study_name are unique so we don't accidentally reuse an old study.

meta:
  symbol: tBTCUSD
  timeframe: 1h
  snapshot_id: snap_tBTCUSD_2024-01-02_2025-12-11_v1
  warmup_bars: 150
  runs:
    strategy: optuna

    # EXPLORE PERIOD (Optuna sees this)
    use_sample_range: true
    sample_start: "2024-01-02"
    sample_end: "2024-12-31"

    # Allow resuming this long run if the process is restarted.
    resume: true
    max_trials: null # run until timeout/end_at
    max_concurrent: 1

    # VALIDATION PERIOD (Optuna does NOT see this)
    validation:
      enabled: true
      top_n: 25
      resume: false
      use_sample_range: true
      sample_start: "2025-01-01"
      sample_end: "2025-12-11"
      constraints:
        # NOTE: With champion-aligned risk_map we observe ~25 trades/year on 2025.
        # Keep validation strict on DD but slightly relax trades/PF so candidates can pass
        # and the pipeline doesn't collapse into "all fail".
        min_trades: 20
        min_profit_factor: 0.75
        max_max_dd: 0.12
        include_scoring_failures: false
        scoring_thresholds:
          min_trades: 20
          min_profit_factor: 0.75
          max_max_dd: 0.12

    promotion:
      enabled: false

    optuna:
      study_name: "optuna_ev_longrun_20260109_20260112_explore2024_validate2025"
      storage: "sqlite:///results/hparam_search/storage/optuna_tBTCUSD_1h_ev_longrun_20260109_20260112.db"
      n_jobs: 1

      # Relative budget (seconds). Kept slightly larger than the wall-clock window;
      # effective budget is MIN(timeout_seconds, time-to-end_at).
      timeout_seconds: 345600 # 96h

      # Absolute deadline (local timezone if no offset is provided).
      end_at: "2026-01-12T23:59:00"

      pruner:
        type: "none"

      sampler:
        type: "tpe"
        kwargs:
          n_startup_trials: 40
          n_ei_candidates: 96
          multivariate: true
          group: true
          # Avoid replaying the bootstrap RandomSampler pseudo-random sequence.
          seed: 43

      # Force a deterministic RandomSampler warm start before TPE.
      bootstrap_random_trials: 32
      bootstrap_seed: 42

constraints:
  # Explore-stage guardrails (mild). Validation does the strict filtering.
  min_trades: 10
  min_profit_factor: 0.55
  max_max_dd: 0.35
  include_scoring_failures: false

  # Align scoring hard-failure thresholds with explore-stage constraints,
  # otherwise PF<1.0 flattens the objective around ~-100 (no learning signal).
  scoring_thresholds:
    min_trades: 10
    min_profit_factor: 0.55
    max_max_dd: 0.35

parameters:
  # --- ENTRY THRESHOLDS ---
  thresholds:
    entry_conf_overall:
      type: float
      low: 0.18
      high: 0.32
      step: 0.01

    min_edge:
      type: fixed
      value: 0.01

    regime_proba:
      balanced:
        type: float
        low: 0.40
        high: 0.60
        step: 0.02
      bull:
        type: float
        low: 0.40
        high: 0.60
        step: 0.02
      bear:
        type: float
        low: 0.40
        high: 0.60
        step: 0.02
      ranging:
        type: float
        low: 0.40
        high: 0.60
        step: 0.02

    # Signal Adaptation (ATR Zones) - primary throughput control.
    signal_adaptation:
      atr_period:
        type: fixed
        value: 28
      zones:
        low:
          entry_conf_overall:
            type: float
            low: 0.20
            high: 0.30
            step: 0.01
          regime_proba:
            type: float
            low: 0.30
            high: 0.45
            step: 0.01
        mid:
          entry_conf_overall:
            type: float
            low: 0.26
            high: 0.36
            step: 0.01
          regime_proba:
            type: float
            low: 0.36
            high: 0.52
            step: 0.01
        high:
          entry_conf_overall:
            type: float
            low: 0.32
            high: 0.44
            step: 0.01
          regime_proba:
            type: float
            low: 0.44
            high: 0.62
            step: 0.01

  # --- EXITS (baseline exits + HTF exits) ---
  exit:
    exit_conf_threshold:
      type: float
      low: 0.34
      high: 0.50
      step: 0.02
    max_hold_bars:
      type: int
      low: 8
      high: 24
      step: 1
    trailing_stop_pct:
      type: float
      low: 0.010
      high: 0.020
      step: 0.001

  # --- RISK (required section for preflight/schema) ---
  # Pin risk_map to the current champion to avoid unintentional risk-policy drift during tuning.
  risk:
    risk_map:
      type: fixed
      value:
        - [0.6, 0.02]
        - [0.7, 0.03]
        - [0.8, 0.04]
        - [0.9, 0.05]

  # --- MULTI-TIMEFRAME CONTROL ---
  multi_timeframe:
    use_htf_block:
      type: fixed
      value: true
    allow_ltf_override:
      type: fixed
      value: true
    ltf_override_threshold:
      type: float
      low: 0.30
      high: 0.60
      step: 0.02

    # Pin HTF selector to 1D for 1h to keep behavior close to the champion.
    htf_selector:
      mode:
        type: fixed
        value: "fixed"
      fallback_timeframe:
        type: fixed
        value: "1D"
      per_timeframe:
        "1h":
          timeframe:
            type: fixed
            value: "1D"
          multiplier:
            type: fixed
            value: null

  # --- FIBONACCI ENTRY GATES ---
  # Keep these close to the current champion to avoid the runtime defaults (often too strict).
  htf_fib:
    entry:
      enabled:
        type: fixed
        value: true
      missing_policy:
        type: fixed
        value: "pass"
      tolerance_atr:
        type: float
        low: 2.0
        high: 6.0
        step: 0.5
      long_max_level:
        type: fixed
        value: 0.236
      short_min_level:
        type: fixed
        value: 0.35

  ltf_fib:
    entry:
      enabled:
        type: fixed
        value: true
      missing_policy:
        type: fixed
        value: "pass"
      tolerance_atr:
        type: float
        low: 0.75
        high: 2.50
        step: 0.25
      long_max_level:
        type: fixed
        value: 0.146
      short_min_level:
        type: fixed
        value: 0.236

  # --- HTF EXITS (Structure & partials) ---
  htf_exit_config:
    partial_1_pct:
      type: float
      low: 0.45
      high: 0.69
      step: 0.02
    partial_2_pct:
      type: float
      low: 0.35
      high: 0.60
      step: 0.05
    fib_threshold_atr:
      type: float
      low: 0.60
      high: 1.20
      step: 0.05
    trail_atr_multiplier:
      type: float
      low: 1.80
      high: 3.60
      step: 0.10

    enable_partials:
      type: fixed
      value: true
    enable_trailing:
      type: fixed
      value: true
    enable_structure_breaks:
      type: fixed
      value: true
    swing_update_strategy:
      type: fixed
      value: "fixed"
