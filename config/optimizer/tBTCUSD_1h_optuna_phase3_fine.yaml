# Optuna Hyperparameter Optimization Configuration - Phase 3 Fine Tuning
#
# Purpose:
#   Fine-tune tBTCUSD 1h strategy to improve Profit Factor (PF) from baseline 1.04 to target >1.2
#   by refining exit strategies and tightening entry conditions while maintaining trade frequency.
#
# Phase Context:
#   - Builds on Phase 2d (v6) results which successfully generated trades but had low PF
#   - Focus: Quality over quantity - accept fewer trades if they are more profitable
#   - Strategy: Widen exit parameter search space and slightly tighten entry thresholds
#
# Configuration Details:
#   - Symbol: tBTCUSD (Tokenized Bitcoin)
#   - Timeframe: 1 hour
#   - Data Snapshot: snap_tBTCUSD_20240401_20250331_v1 (12 months)
#   - Optimization Runs: 50 trials with 4 concurrent workers
#   - Sampler: TPE (Tree-structured Parzen Estimator) with multivariate and constant liar strategies
#
# Constraints:
#   - min_trades: 30 (reduced to allow high-quality, lower-frequency strategies)
#   - min_profit_factor: 1.00 (ensures current baseline is valid)
#   - max_max_dd: 20% (maximum drawdown limit)
#
# Parameter Search Spaces:
#   1. Entry Thresholds: Centered around Phase 2d best trials (0.26-0.32)
#   2. Regime Probabilities: Balanced (0.45-0.55), Ranging (0.50-0.65)
#   3. Signal Adaptation Zones: Low/Mid/High with progressively tighter thresholds
#   4. Exit Strategy: CRITICAL - widened search space (0.30-0.55 conf, 12-48 bars hold time)
#   5. Risk Map Deltas: Fine adjustments to position sizing per confidence level
#   6. Multi-Timeframe: LTF override threshold (0.55-0.75)
#
# Expected Outcomes:
#   - Highername: tBTCUSD_1h_optuna_phase3_fine
# Phase 3: Fine Tuning (Quality Focus)
# Based on Phase 2d (v6) results which unlocked trades but had low PF (1.04).
# Goal: Increase PF > 1.2 by refining exits and slightly tightening entries.

meta:
  symbol: tBTCUSD
  timeframe: 1h
  snapshot_id: snap_tBTCUSD_20240401_20250331_v1
  runs:
    strategy: optuna
    resume: false
    max_trials: 50
    max_concurrent: 4
    use_sample_range: true # Use dates from snapshot_id
    optuna:
      study_name: optuna_phase3_fine_12m_v3
      storage: sqlite:///results/hparam_search/storage/optuna_phase3_fine_v3.db
      sampler:
        name: tpe
        kwargs:
          n_startup_trials: 20
          n_ei_candidates: 24
          multivariate: true
          constant_liar: true

constraints:
  min_trades: 30 # Lowered to 30 to accept high-quality/low-freq solutions
  min_profit_factor: 1.00 # Lowered to 1.00 to ensure current baseline (1.04) is accepted
  max_max_dd: 0.20
  include_scoring_failures: true

parameters:
  # 1. Thresholds - Centered on Phase 2d Best Trials (0.26-0.28)
  thresholds.entry_conf_overall:
    type: float
    low: 0.26
    high: 0.32
    step: 0.01

  thresholds.regime_proba.balanced:
    type: float
    low: 0.45
    high: 0.55
    step: 0.02
  thresholds.regime_proba.bull:
    type: float
    low: 0.45
    high: 0.55
    step: 0.02
  thresholds.regime_proba.bear:
    type: float
    low: 0.45
    high: 0.55
    step: 0.02
  thresholds.regime_proba.ranging:
    type: float
    low: 0.50
    high: 0.65
    step: 0.02

  thresholds.min_edge:
    type: float
    low: 0.006
    high: 0.014
    step: 0.002

  # 2. Signal Adaptation - Slightly tighter than v6
  thresholds.signal_adaptation.zones.low.entry_conf_overall:
    type: float
    low: 0.24
    high: 0.30
    step: 0.01
  thresholds.signal_adaptation.zones.low.regime_proba.balanced:
    type: float
    low: 0.40
    high: 0.50
    step: 0.02
  thresholds.signal_adaptation.zones.low.regime_proba.bull:
    type: float
    low: 0.40
    high: 0.50
    step: 0.02
  thresholds.signal_adaptation.zones.low.regime_proba.bear:
    type: float
    low: 0.40
    high: 0.50
    step: 0.02
  thresholds.signal_adaptation.zones.low.regime_proba.ranging:
    type: float
    low: 0.50
    high: 0.60
    step: 0.02

  thresholds.signal_adaptation.zones.mid.entry_conf_overall:
    type: float
    low: 0.28
    high: 0.34
    step: 0.01
  thresholds.signal_adaptation.zones.mid.regime_proba.balanced:
    type: float
    low: 0.45
    high: 0.55
    step: 0.02
  thresholds.signal_adaptation.zones.mid.regime_proba.bull:
    type: float
    low: 0.45
    high: 0.55
    step: 0.02
  thresholds.signal_adaptation.zones.mid.regime_proba.bear:
    type: float
    low: 0.45
    high: 0.55
    step: 0.02
  thresholds.signal_adaptation.zones.mid.regime_proba.ranging:
    type: float
    low: 0.50
    high: 0.60
    step: 0.02

  thresholds.signal_adaptation.zones.high.entry_conf_overall:
    type: float
    low: 0.34
    high: 0.42
    step: 0.01
  thresholds.signal_adaptation.zones.high.regime_proba.balanced:
    type: float
    low: 0.45
    high: 0.55
    step: 0.02
  thresholds.signal_adaptation.zones.high.regime_proba.bull:
    type: float
    low: 0.45
    high: 0.55
    step: 0.02
  thresholds.signal_adaptation.zones.high.regime_proba.bear:
    type: float
    low: 0.45
    high: 0.55
    step: 0.02
  thresholds.signal_adaptation.zones.high.regime_proba.ranging:
    type: float
    low: 0.50
    high: 0.60
    step: 0.02

  # 3. Exits - WIDER SEARCH (Critical for PF)
  exit.exit_conf_threshold:
    type: float
    low: 0.30
    high: 0.55
    step: 0.02
  exit.max_hold_bars:
    type: int
    low: 12
    high: 48
    step: 4
  exit.trailing_stop_enabled:
    type: grid
    values: [true, false]
  exit.trailing_stop_pct:
    type: float
    low: 0.01
    high: 0.04
    step: 0.005

  # 4. Risk Map - Fine Tuning
  risk.risk_map_deltas.conf_0:
    type: float
    low: -0.05
    high: 0.05
    step: 0.01
  risk.risk_map_deltas.size_0:
    type: float
    low: -0.01
    high: 0.02
    step: 0.005
  risk.risk_map_deltas.conf_1:
    type: float
    low: -0.05
    high: 0.05
    step: 0.01
  risk.risk_map_deltas.size_1:
    type: float
    low: -0.01
    high: 0.02
    step: 0.005
  risk.risk_map_deltas.conf_2:
    type: float
    low: -0.05
    high: 0.05
    step: 0.01
  risk.risk_map_deltas.size_2:
    type: float
    low: -0.01
    high: 0.04
    step: 0.005

  # 5. Multi-Timeframe
  multi_timeframe.ltf_override_threshold:
    type: float
    low: 0.55
    high: 0.75
    step: 0.02
