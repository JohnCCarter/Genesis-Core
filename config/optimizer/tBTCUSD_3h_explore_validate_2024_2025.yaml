description: "Explore on 2024, Validate (rank) on 2025 - 3h timeframe"
#
# Purpose: Avoid overfitting by exploring on 2024 but ranking candidates
# by their out-of-sample performance on 2025.

meta:
  symbol: tBTCUSD
  timeframe: 3h
  snapshot_id: snap_tBTCUSD_3h_2024-01-02_2024-12-31_v1
  warmup_bars: 120
  runs:
    strategy: optuna

    # EXPLORE period (in-sample)
    use_sample_range: true
    sample_start: "2024-01-02"
    sample_end: "2024-12-31"

    # VALIDATE period (out-of-sample) - used to rank candidates
    validation:
      enabled: true
      use_sample_range: true
      sample_start: "2025-01-01"
      sample_end: "2025-12-31"
      top_n: 5 # Validate top-5 from explore

      # Stricter constraints in validation to rank/select a real champion.
      # Keep explore constraints looser to preserve learning signal.
      constraints:
        include_scoring_failures: false
        min_trades: 10
        min_profit_factor: 1.05
        max_max_dd: 0.45

    resume: false
    max_trials: 80
    max_concurrent: 1

    promotion:
      enabled: false # Manual promotion after review

    optuna:
      study_name: "optuna_3h_explore_validate_2024_2025_v2"
      storage: "sqlite:///results/hparam_search/storage/optuna_tBTCUSD_3h_explore_validate_2024_2025_v2.db"
      n_jobs: 1
      timeout_seconds: 14400 # 4h

      # Helps TPE avoid early degeneracy/duplicates on discrete-heavy spaces.
      bootstrap_random_trials: 20
      bootstrap_seed: 42

      pruner:
        type: "none"

      sampler:
        type: "tpe"
        kwargs:
          n_startup_trials: 25
          n_ei_candidates: 96
          multivariate: true
          group: true
          constant_liar: true
          seed: 42

constraints:
  include_scoring_failures: false
  max_max_dd: 0.85
  min_profit_factor: 0.60

  scoring_thresholds:
    min_trades: 0
    min_profit_factor: 0.0
    max_max_dd: 1.0

parameters:
  thresholds:
    entry_conf_overall:
      type: float
      low: 0.18
      high: 0.32
      step: 0.01

    min_edge:
      type: fixed
      value: 0.01

    regime_proba:
      balanced:
        type: float
        low: 0.40
        high: 0.60
        step: 0.02
      bull:
        type: float
        low: 0.40
        high: 0.60
        step: 0.02
      bear:
        type: float
        low: 0.40
        high: 0.60
        step: 0.02
      ranging:
        type: float
        low: 0.40
        high: 0.60
        step: 0.02

    signal_adaptation:
      atr_period:
        type: fixed
        value: 28
      zones:
        low:
          entry_conf_overall:
            type: float
            low: 0.20
            high: 0.30
            step: 0.01
          regime_proba:
            type: float
            low: 0.30
            high: 0.45
            step: 0.01
        mid:
          entry_conf_overall:
            type: float
            low: 0.26
            high: 0.36
            step: 0.01
          regime_proba:
            type: float
            low: 0.36
            high: 0.52
            step: 0.01
        high:
          entry_conf_overall:
            type: float
            low: 0.32
            high: 0.44
            step: 0.01
          regime_proba:
            type: float
            low: 0.44
            high: 0.62
            step: 0.01

  exit:
    exit_conf_threshold:
      type: float
      low: 0.34
      high: 0.50
      step: 0.02
    max_hold_bars:
      type: int
      low: 6
      high: 20
      step: 1
    trailing_stop_pct:
      type: float
      low: 0.010
      high: 0.020
      step: 0.001

  risk:
    risk_map:
      type: fixed
      value:
        - [0.6, 0.02]
        - [0.7, 0.03]
        - [0.8, 0.04]
        - [0.9, 0.05]
    regime_size_multipliers:
      type: fixed
      value:
        bull: 1.0
        bear: 0.7
        ranging: 0.5
        balanced: 0.8

    # NEW: HTF regime sizing (1D-based defensive sizing)
    htf_regime_size_multipliers:
      bull:
        type: float
        low: 0.80
        high: 1.00
        step: 0.05
      bear:
        type: float
        low: 0.30
        high: 0.60
        step: 0.05
      ranging:
        type: float
        low: 0.50
        high: 0.80
        step: 0.05
      unknown:
        type: float
        low: 0.60
        high: 0.90
        step: 0.05

    # NEW: Volatility-based sizing
    volatility_sizing:
      enabled:
        type: fixed
        value: true
      high_vol_threshold:
        type: int
        # Keep >=80 so decision.py consistently uses p80 (avoid p40/p80 discontinuity).
        low: 80
        high: 90
        step: 5
      high_vol_multiplier:
        type: float
        low: 0.50
        high: 0.80
        step: 0.05
      atr_period:
        type: fixed
        value: 14

    min_combined_multiplier:
      type: float
      low: 0.10
      high: 0.25
      step: 0.05

  multi_timeframe:
    use_htf_block:
      type: fixed
      value: true
    allow_ltf_override:
      type: grid
      values: [true, false]
    ltf_override_threshold:
      type: float
      low: 0.30
      high: 0.60
      step: 0.02

    htf_selector:
      mode:
        type: fixed
        value: "fixed"
      fallback_timeframe:
        type: fixed
        value: "1D"
      per_timeframe:
        "3h":
          timeframe:
            type: fixed
            value: "1D"
          multiplier:
            type: fixed
            value: null

  htf_fib:
    entry:
      enabled:
        type: fixed
        value: true
      missing_policy:
        type: fixed
        value: "pass"
      tolerance_atr:
        type: float
        low: 2.0
        high: 6.0
        step: 0.5
      long_max_level:
        type: fixed
        value: 0.236
      short_min_level:
        type: fixed
        value: 0.35

  ltf_fib:
    entry:
      enabled:
        type: fixed
        value: true
      missing_policy:
        type: fixed
        value: "pass"
      tolerance_atr:
        type: float
        low: 0.75
        high: 2.50
        step: 0.25
      long_max_level:
        type: fixed
        value: 0.146
      short_min_level:
        type: fixed
        value: 0.236

  htf_exit_config:
    partial_1_pct:
      type: float
      low: 0.45
      high: 0.69
      step: 0.02
    partial_2_pct:
      type: float
      low: 0.35
      high: 0.60
      step: 0.05
    fib_threshold_atr:
      type: float
      low: 0.60
      high: 1.20
      step: 0.05
    trail_atr_multiplier:
      type: float
      low: 1.80
      high: 3.60
      step: 0.10
    enable_partials:
      type: fixed
      value: true
    enable_trailing:
      type: fixed
      value: true
